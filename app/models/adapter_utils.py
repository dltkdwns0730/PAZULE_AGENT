"""Shared helpers for model adapters."""

from __future__ import annotations

import json
import re
from typing import Any, Dict, Iterable


def _tokenize(text: str) -> list[str]:
    """Caller: ?? ?? ???? ???
    Purpose: `_tokenize` ?? ??? ????
    Returns: ?? ?? ?? ??
    Deps: ?? ??? ??
    Args: text: ???? ???? ??
    Note: ?? ?? ?? ???? ???"""
    return re.findall(r"[A-Za-z0-9가-힣]+", (text or "").lower())


def text_overlap_score(query: str, corpus: str) -> float:
    """Caller: ?? ?? ???? ???
    Purpose: `text_overlap_score` ?? ??? ????
    Returns: ?? ?? ?? ??
    Deps: ?? ??? ??
    Args: query: ???? ???? ??; corpus: ???? ???? ??
    Note: ?? ?? ?? ???? ???"""
    q = set(_tokenize(query))
    c = set(_tokenize(corpus))
    if not q:
        return 0.0
    inter = len(q.intersection(c))
    return min(1.0, inter / max(1, len(q)))


def normalize_label(score: float, threshold: float = 0.6) -> str:
    """Caller: ?? ?? ???? ???
    Purpose: `normalize_label` ?? ??? ????
    Returns: ?? ?? ?? ??
    Deps: ?? ??? ??
    Args: score: ???? ???? ??; threshold: ???? ???? ??
    Note: ?? ?? ?? ???? ???"""
    return "match" if score >= threshold else "mismatch"


def safe_json_loads(content: str) -> Dict[str, Any]:
    """Caller: ?? ?? ???? ???
    Purpose: `safe_json_loads` ?? ??? ????
    Returns: ?? ?? ?? ??
    Deps: ?? ??? ??
    Args: content: ???? ???? ??
    Note: ?? ?? ?? ???? ???"""
    text = (content or "").strip().replace("```json", "").replace("```", "").strip()
    try:
        return json.loads(text)
    except Exception:
        return {}


def join_non_empty(parts: Iterable[str], sep: str = "\n") -> str:
    """Caller: ?? ?? ???? ???
    Purpose: `join_non_empty` ?? ??? ????
    Returns: ?? ?? ?? ??
    Deps: ?? ??? ??
    Args: parts: ???? ???? ??; sep: ???? ???? ??
    Note: ?? ?? ?? ???? ???"""
    return sep.join([p for p in parts if p])

