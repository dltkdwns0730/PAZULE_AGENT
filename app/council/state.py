"""Pipeline state contracts for the mission orchestration graph."""

import operator
from typing import Annotated, Any, Dict, List, NotRequired, TypedDict


class ErrorEvent(TypedDict):
    """Purpose: `ErrorEvent` ??? ??? ?? ??? ???
    Context: ?? ???? ?? ??? ??? ??
    Attrs: ?? ?? ???? ?? ??? ???"""
    code: str
    message: str
    node: str
    retryable: bool
    model: NotRequired[str]


class ControlFlags(TypedDict, total=False):
    """Purpose: `ControlFlags` ??? ??? ?? ??? ???
    Context: ?? ???? ?? ??? ??? ??
    Attrs: ?? ?? ???? ?? ??? ???"""
    should_retry: bool
    degrade_mode: bool
    terminate: bool
    manual_review: bool


class RouteDecision(TypedDict):
    """Purpose: `RouteDecision` ??? ??? ?? ??? ???
    Context: ?? ???? ?? ??? ??? ??
    Attrs: ?? ?? ???? ?? ??? ???"""
    next_node: str
    reason: str
    confidence: float
    fallback: str


class ModelVote(TypedDict, total=False):
    """Purpose: `ModelVote` ??? ??? ?? ??? ???
    Context: ?? ???? ?? ??? ??? ??
    Attrs: ?? ?? ???? ?? ??? ???"""
    model: str
    mission_type: str
    label: str
    score: float
    confidence: float
    reason: str
    latency_ms: float
    success: bool
    evidence: Dict[str, Any]


class PipelineState(TypedDict, total=False):
    """Purpose: `PipelineState` ??? ??? ?? ??? ???
    Context: ?? ???? ?? ??? ??? ??
    Attrs: ?? ?? ???? ?? ??? ???"""
    request_context: Dict[str, Any]
    artifacts: Dict[str, Any]
    errors: List[ErrorEvent]
    control_flags: ControlFlags
    route_decision: RouteDecision
    final_response: Dict[str, Any]
    messages: Annotated[List[str], operator.add]
